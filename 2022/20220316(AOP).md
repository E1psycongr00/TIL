# 20220316(Spring AOP)

ì‘ì„±ì¼ì‹œ: 2022ë…„ 3ì›” 16ì¼ ì˜¤ì „ 12:08

# AOP ì˜ì¡´ì„±

AOPë¥¼ ë³¸ê²©ì ìœ¼ë¡œ ì´ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” aspectj ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜ í•´ì¤˜ì•¼ í•œë‹¤.

```xml
<!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver -->
		<dependency>
			<groupId>org.aspectj</groupId>
			<artifactId>aspectjweaver</artifactId>
			<version>1.9.4</version>
		</dependency>
```

# PointCut

pointcutì€ íƒ€ê²ŸíŒ…ì„ í•  ë•Œ ì‚¬ìš©í•œë‹¤. pointcut aspectì˜ ì´ì •í‘œë¡œ ì´í•´í•˜ë©´ í¸í•  ë“¯ í•˜ë‹¤.

## pointcutì˜ í‘œí˜„ì‹

**execution(return type, package.class.method(parameter type)**

ex) execution(* list(..)):  íŒ¨í‚¤ì§€.í´ë˜ìŠ¤ëŠ” ìƒê´€ì´ ì—†ê³   listë¼ëŠ” ë©”ì„œë“œë¥¼ ì°¾ëŠ”ë‹¤.

ex) **execution(* hello())**:  íŒ¨í‚¤ì§€.í´ë˜ìŠ¤ëŠ” ìƒê´€ì´ ì—†ê³  helloë¼ëŠ” ë©”ì„œë“œë¥¼ ì°¾ëŠ”ë° íŒŒë¼ë¯¸í„°ëŠ” ì—†ì–´ì•¼í•œë‹¤.

ex) execution( * myspring.user.service.UserServiceImpl.*(..)) : íŒ¨í‚¤ì§€ì˜ í´ë˜ìŠ¤ì•ˆ ëª¨ë“  ë©”ì„œë“œ ì§€ì •

ex)Â ****execution( * myspring.user.service.*.*(..)) : íŒ¨í‚¤ì§€ì˜ ëª¨ë“  í´ë˜ìŠ¤ì˜ ëª¨ë“  ë©”ì„œë“œë¥¼ íƒ€ê²Ÿí•œë‹¤.

<aside>
ğŸ’¡ *ì€ ëª¨ë“  ì´ë¼ëŠ” ì˜ë¯¸ë¥¼ ì˜ë¯¸ í•  ìˆ˜ ìˆë‹¤.

</aside>

# Advise

ì–´ë“œë°”ì´ìŠ¤ëŠ” íƒ€ê²Ÿ ë©”ì„œë“œì˜ ìˆ˜í–‰ ì´ì „,ì´í›„, í•¨ìˆ˜ê°€ ì„±ê³µì ìœ¼ë¡œ ë¦¬í„´ì„ í–ˆì„ ê²½ìš°, ì˜ˆì™¸ì˜ ê²½ìš° ì´ì „ê¹Œì§€ ê²½ìš°ë¥¼ ëª¨ë‘ ë°œìƒí•˜ëŠ” ê²½ìš°ê°€ ìˆë‹¤. 

1. **BeforeAdvice** : íƒ€ê¹ƒ ë©”ì„œë“œ ìˆ˜í–‰ ì´ì „
2. **AfterAdvice**: íƒ€ê¹ƒ ë©”ì„œë“œ ìˆ˜í–‰ ì´í›„
3. **AfterReturningAdvice**: íƒ€ê¹ƒ ë©”ì„œë“œ ì„±ê³µì ìœ¼ë¡œ íƒ€ì… ë¦¬í„´ì‹œ
4. **ThrowingAdvice**: íƒ€ê¹ƒ ë©”ì„œë“œ ìˆ˜í–‰ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí•œ ê²½ìš°
5. **Around**: 1~4 ëª¨ë‘ ë°œí–‰

## adviceì˜ í™œìš©

```java
@Aspect
public class UserServiceAspect {
  //1. pointcutì™€ advice ë¶„ë¦¬
	@Pointcut("execution(* list(..))")// the pointcut expression
	private void anyOldTransfer() {}// the pointcut signature
	
	@Before("anyOldTransfer()")
    public void doAccessCheck(JoinPoint point) {
		System.out.println("point:" + point);
		System.out.println("methodëª…:" + point.getSignature().getName());
        System.out.println("UserServiceAspect.BeforeAdvice.list");
    }
	
	//2. pointcutì™€ advice í•©ì¹˜ê¸°
	@Before("execution(* insert*(..))")
    public void doAccessCheck2(JoinPoint point) {
//		System.out.println("point:" + point);
//		System.out.println("methodëª…:" + point.getSignature().getName());
        System.out.println("UserServiceAspect.BeforeAdvice.insert");
    }
	
	@After("execution(* insert*(..))")
    public void doAccessCheck3(JoinPoint point) {
//		System.out.println("point:" + point);
//		System.out.println("methodëª…:" + point.getSignature().getName());
        System.out.println("UserServiceAspect.AfterAdvice.insert");
    }
	
	
}
```

afterReturningì¸ returning ì¸ìë¥¼ ê°€ì§„ë‹¤. returningì€ ë¦¬í„´ê°’ì„ ì €ì¥í•  ë³€ìˆ˜ëª…ì„ ë„£ì–´ì£¼ë©´ ëœë‹¤.

```java
@Aspect
public class DeptServiceAspect {

	@AfterReturning(pointcut = "execution(* selectList(..))", returning = "retVal")
	public void doAccessCheck(Object retVal) {
		System.out.println("DeptServiceAspect.AfterReturning.selectList");
		System.out.println("ë¦¬í„´ê°’:" + retVal);
	}
}
```

```java
@AfterThrowing(pointcut = "execution(* update(..))", throwing = "ex")
	public void doRecoveryActions(Exception ex) {
		System.out.println("EmpServiceAspect.AfterThrowing" 
	     + ex.getMessage());
	}
```

```java
@Around("execution(* delete(..))")
	    public Object doBasicProfiling(ProceedingJoinPoint pjp) throws Throwable {
	        System.out.println("Before Advice");
	        Object retVal = pjp.proceed();
	        System.out.println("After Advice");
	        System.out.println("retVal:" + retVal);
	        return retVal;
	    }
```

# Aspect

Advise + pointcut = Aspectì´ë‹¤. ì¦‰ aspectëŠ” íƒ€ê¹ƒë©”ì„œë“œì˜ ìˆ˜í–‰ ì‹œì  ê¸°ì¤€ìœ¼ë¡œ aspectë¥¼ ì–¸ì œ í˜¸ì¶œí•  ì§€ + ì–´ë–¤ í´ë˜ìŠ¤ì˜ ì–´ë–¤ ë©”ì„œë“œì— ì ìš©í• ì§€ ì¢Œí‘œê°€ í•©ì³ì§„ ê°œë…ì´ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤.

**<aop:aspectj-autoproxy />** íƒœê·¸ëŠ” @aspectê°€ ëœ ë¹ˆì„ ìë™ìœ¼ë¡œ aspect ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë„ë¡ í•´ì¤Œ.

# JoinPoint ì¸í„°í˜ì´ìŠ¤

- AOPê°€ ì ìš©ë˜ëŠ” ì§€ì 
- ëª¨ë“  ì–´ë“œë°”ì´ìŠ¤ëŠ” org.aspectj.lang.JoinPoint íƒ€ì…ì˜ íŒŒë¼ë¯¸í„°ë¥¼ ì–´ë“œë°”ì´ìŠ¤ ë©”ì„œë“œì— ì²« ë²ˆì§¸ ë§¤ê°œë³€ìˆ˜ë¡œ ì„ ì–¸ ê°€ëŠ¥.
- Around ì–´ë“œë°”ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° proceedingJointPoint íƒ€ì…ì˜ íŒŒë¼ë¯¸í„°ë¥¼ í•„ìˆ˜ì ìœ¼ë¡œ ì„ ì–¸í•´ì•¼í•¨.

```java
@Around("execution(* kr.co.acomp.hello.service.*Service.*(..))")
	public Object measuringMethodObject(
			ProceedingJoinPoint joinPoint) throws Throwable{
		
		long start = System.currentTimeMillis();
		
		// Proceed ì‹¤ì œ íƒ€ê²Ÿ ë©”ì„œë“œ ì‹¤í–‰
		try {
			return joinPoint.proceed();
		} finally {
			long result = System.currentTimeMillis() - start;
			String targetMethodName = joinPoint.getSignature().getName(); // ë©”ì†Œë“œ ì´ë¦„ í™•ì¸
			System.out.println(targetMethodName + "running time is " + result); // log
		}
	}
```

# AOP xml ë¹ˆ ë“±ë¡ ì—†ì´ ì ìš©í•˜ëŠ” ë²•

```xml
<aop:aspectj-autoproxy />

<context:component-scan base-package="com.*" />
```

autoproxyë¡œ aspectê°€ ì‹¤ì œë¡œ ì ìš© ë  ìˆ˜ ìˆê²Œ í•´ì£¼ê³  component-scanì„ ì´ìš©í•´ ë¹ˆì„ ìë™ìœ¼ë¡œ ë“±ë¡í•œë‹¤. ì´ë•ŒëŠ” ê¸°ì¡´ aspectì— ì»´í¬ë„ŒíŠ¸ë¥¼ ì ìš©í•´ì£¼ë©´ ëœë‹¤.

ì»´í¬ë„ŒíŠ¸, ì„œë¹„ìŠ¤, ë ˆí¬ì§€í† ë¦¬, ì»¨íŠ¸ë¡¤ëŸ¬ ë“±  ìŠ¤ìº”ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

```java
@Aspect
@Component
public class UserServiceAspect {
  //1. pointcutì™€ advice ë¶„ë¦¬
	@Pointcut("execution(* list(..))")// the pointcut expression
	private void anyOldTransfer() {}// the pointcut signature
	
	@Before("anyOldTransfer()")
    public void doAccessCheck(JoinPoint point) {
		System.out.println("point:" + point);
		System.out.println("methodëª…:" + point.getSignature().getName());
        System.out.println("UserServiceAspect.BeforeAdvice.list");
    }
	
	//2. pointcutì™€ advice í•©ì¹˜ê¸°
	@Before("execution(* insert*(..))")
    public void doAccessCheck2(JoinPoint point) {
//		System.out.println("point:" + point);
//		System.out.println("methodëª…:" + point.getSignature().getName());
        System.out.println("UserServiceAspect.BeforeAdvice.insert");
    }
	
	@After("execution(* insert*(..))")
    public void doAccessCheck3(JoinPoint point) {
//		System.out.println("point:" + point);
//		System.out.println("methodëª…:" + point.getSignature().getName());
        System.out.println("UserServiceAspect.AfterAdvice.insert");
    }
	
}
```